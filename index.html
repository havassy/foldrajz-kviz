<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F√∂ldrajz Kv√≠z - Gyakorl√°s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<div id="app"></div>

<script>
// ============================================
// KONFIGUR√ÅCI√ì
// ============================================

// Pr√≥b√°land√≥ modellek sorrendben
const MODELS_TO_TRY = [
    'gemini-2.0-flash-exp',
    'gemini-1.5-flash',
    'gemini-1.5-pro',
    'gemini-pro',
    'gemini-1.5-flash-latest'
];

let WORKING_MODEL = null;

// ============================================
// ALKALMAZ√ÅS LOGIKA
// ============================================
let appState = {
    apiKey: localStorage.getItem('gemini_api_key') || '',
    isSetupComplete: false,
    questions: [],
    filteredQuestions: [],
    currentQuestion: null,
    userAnswer: '',
    evaluation: null,
    isLoading: false,
    errorMessage: '',
    selectedTopic: 'mind',
    selectedDifficulty: 'mind',
    topics: [],
    difficulties: [],
    hintsUsed: 0,
    revealedKeywords: [],
    askedQuestionIds: [],
    totalAsked: 0
};

// CSV sz√∂veg feldolgoz√°sa
function parseCSVText(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];

    const loadedQuestions = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(/[,\t]/);
        
        if (values.length >= 3) {
            loadedQuestions.push({
                id: i,
                question: values[0]?.trim() || '',
                sampleAnswer: values[1]?.trim() || '',
                keywords: values[2]?.trim() || '',
                commonMistakes: values[3]?.trim() || '',
                topic: values[4]?.trim() || '√Åltal√°nos',
                difficulty: values[5]?.trim() || 'K√∂zepes'
            });
        }
    }
    
    return loadedQuestions.filter(q => q.question !== '');
}

// CSV bet√∂lt√©se automatikusan
async function loadQuestionsFromCSV() {
    try {
        appState.isLoading = true;
        appState.errorMessage = '';
        render();
        
        const response = await fetch('ai3.csv');
        
        if (!response.ok) {
            throw new Error('CSV f√°jl nem tal√°lhat√≥! Ellen≈ërizd, hogy az ai3.csv f√°jl fel van-e t√∂ltve.');
        }
        
        const csvText = await response.text();
        const parsed = parseCSVText(csvText);
        
        if (parsed.length === 0) {
            throw new Error('Nem siker√ºlt k√©rd√©seket beolvasni a CSV-b≈ël!');
        }
        
        appState.questions = parsed;
        appState.topics = [...new Set(parsed.map(q => q.topic))];
        appState.difficulties = [...new Set(parsed.map(q => q.difficulty))];
        appState.isLoading = false;
        
        console.log(`‚úÖ ${parsed.length} k√©rd√©s bet√∂ltve!`);
        
        // Ha van API kulcs, kezdj√ºk
        if (appState.apiKey) {
            appState.isSetupComplete = true;
            selectRandomQuestion();
        } else {
            render();
        }
        
    } catch (error) {
        console.error('CSV bet√∂lt√©si hiba:', error);
        appState.errorMessage = `Hiba a k√©rd√©sek bet√∂lt√©s√©ben: ${error.message}`;
        appState.isLoading = false;
        render();
    }
}

// Random k√©rd√©s kiv√°laszt√°sa (ism√©tl≈ëd√©s n√©lk√ºl)
function selectRandomQuestion() {
    const filtered = filterQuestions();
    if (filtered.length === 0) return;
    
    const unanswered = filtered.filter(q => !appState.askedQuestionIds.includes(q.id));
    
    if (unanswered.length === 0) {
        appState.askedQuestionIds = [];
        appState.errorMessage = 'üéâ Gratul√°lok! V√©gigment√©l az √∂sszes k√©rd√©sen! Kezdj√ºk el√∂lr≈ël!';
        setTimeout(() => {
            appState.errorMessage = '';
            selectRandomQuestion();
        }, 2000);
        render();
        return;
    }
    
    const randomIndex = Math.floor(Math.random() * unanswered.length);
    appState.currentQuestion = unanswered[randomIndex];
    appState.askedQuestionIds.push(appState.currentQuestion.id);
    
    appState.userAnswer = '';
    appState.evaluation = null;
    appState.errorMessage = '';
    appState.hintsUsed = 0;
    appState.revealedKeywords = [];
    
    render();
}

// Kulcssz√≥ k√©r√©se (puska)
function requestHint() {
    if (!appState.currentQuestion || !appState.currentQuestion.keywords) return;
    
    const allKeywords = appState.currentQuestion.keywords.split(',').map(k => k.trim());
    const unrevealed = allKeywords.filter(k => !appState.revealedKeywords.includes(k));
    
    if (unrevealed.length === 0) {
        appState.errorMessage = 'M√°r minden kulcssz√≥t megmutatt√°l!';
        render();
        return;
    }
    
    const randomKeyword = unrevealed[Math.floor(Math.random() * unrevealed.length)];
    appState.revealedKeywords.push(randomKeyword);
    appState.hintsUsed++;
    appState.errorMessage = '';
    
    render();
}

// K√©rd√©sek sz≈±r√©se
function filterQuestions() {
    let filtered = appState.questions;
    
    if (appState.selectedTopic !== 'mind') {
        filtered = filtered.filter(q => q.topic === appState.selectedTopic);
    }
    
    if (appState.selectedDifficulty !== 'mind') {
        filtered = filtered.filter(q => q.difficulty === appState.selectedDifficulty);
    }
    
    appState.filteredQuestions = filtered;
    return filtered;
}

// Sz≈±r≈ë megv√°ltoztat√°sakor reset
function changeFilter(type, value) {
    if (type === 'topic') {
        appState.selectedTopic = value;
    } else if (type === 'difficulty') {
        appState.selectedDifficulty = value;
    }
    
    appState.askedQuestionIds = [];
    appState.evaluation = null;
    
    filterQuestions();
    selectRandomQuestion();
}

// API kulcs be√°ll√≠t√°sa
function handleSetup() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    
    if (!apiKey) {
        alert('Add meg a Gemini API kulcsot!');
        return;
    }
    
    appState.apiKey = apiKey;
    localStorage.setItem('gemini_api_key', apiKey);
    
    appState.isSetupComplete = true;
    selectRandomQuestion();
}

// API kulcs t√∂rl√©se
function clearApiKey() {
    if (confirm('Biztosan t√∂rl√∂d az API kulcsot?')) {
        localStorage.removeItem('gemini_api_key');
        appState.apiKey = '';
        appState.isSetupComplete = false;
        render();
    }
}

// V√°lasz √©rt√©kel√©se
async function evaluateAnswer() {
    if (!appState.userAnswer.trim()) {
        appState.errorMessage = 'K√©rlek, √≠rj be egy v√°laszt!';
        render();
        return;
    }

    appState.isLoading = true;
    appState.errorMessage = '';
    render();
    
    const prompt = `Te egy seg√≠t≈ëk√©sz f√∂ldrajz tan√°r vagy, aki di√°kok v√°laszait √©rt√©keli.

K√âRD√âS: ${appState.currentQuestion.question}

MINTAV√ÅLASZ (amit elv√°runk): ${appState.currentQuestion.sampleAnswer}

‚ö†Ô∏è FONTOS A MINTAV√ÅLASZR√ìL:
- A mintav√°lasz HELYES √©s alapvet≈ë referencia!
- DE nem az egyetlen helyes v√°lasz - l√©gy rugalmas!
- Ha a di√°k m√°s helyes v√°laszt ad (faktikusan igaz) ‚Üí FOGADD EL!
- DE SOHA ne c√°fold vagy b√≠r√°ld fel√ºl a mintav√°laszt!
- NE mondd azt, hogy a minta "nem mindig igaz" vagy "esetenk√©nt m√°s"!
- Ha a di√°k hib√°t √≠r, HIVATKOZZ a mintav√°laszra mint helyes inform√°ci√≥ra!

K√ñTELEZ≈ê KULCSSZAVAK/FOGALMAK (ezeknek szerepelni√ºk kell a v√°laszban, vagy szinonim√°iknak): ${appState.currentQuestion.keywords}

${appState.currentQuestion.commonMistakes ? `
TIPIKUS HIB√ÅK/T√âVHITEK (ha a di√°k ezeket √≠rja, MAXIMUM 2-3 pont adhat√≥!):
${appState.currentQuestion.commonMistakes}
` : ''}

DI√ÅK V√ÅLASZA: ${appState.userAnswer}

‚ö†Ô∏è KRITIKUS - NE √çRD BE A TELJES MINTAV√ÅLASZT!
- A di√°k bem√°soln√°!
- Csak a HI√ÅNYZ√ì KULCSFOGALMAKAT!

SZIGOR√ö PONTOZ√ÅSI SZAB√ÅLYOK:

‚ö†Ô∏è KRITIKUS SZAB√ÅLY - 10 PONT AD√ÅS√ÅNAK FELT√âTELE:
Ha a v√°lasz:
- Tartalmilag HELYES (nincs t√©ved√©s, t√©vhit)
- Legal√°bb 1-2 TELJES MONDATBAN megfogalmazva
- Minden KULCSSZ√ì megvan (vagy szinonim√°ja)
‚Üí AKKOR K√ñTELEZ≈ê 10 PONTOT ADNI!

HA 9 PONTOT AKARSZ ADNI, AKKOR A "hianyossagok" MEZ≈êBEN K√ñTELEZ≈ê KONKR√âTAN MEGNEVEZNI, MI HI√ÅNYZIK!
Ha nem tudsz konkr√©t hi√°nyoss√°got mondani ‚Üí 10 pont kell!

1. MONDATOS V√ÅLASZ K√ñVETELM√âNYE:
   
   FIGYELEM - ELLEN≈êRIZD A K√âRD√âS T√çPUS√ÅT!
   
   A) Ha a K√âRD√âS FELSOROL√ÅST K√âR (pl. "Sorold fel...", "Melyek...", "Milyen t√≠pusai...", "Csoportos√≠tsd..."):
      - Akkor a FELSOROL√ÅS ELFOGADHAT√ì √©s megfelel≈ë v√°lasz!
      - NEM kell bevezet≈ë mondatot √≠rni
      - Ha a di√°k helyesen felsorol ‚Üí ak√°r 10 pont is adhat√≥!
      - P√©lda j√≥ v√°lasz: "√Ålland√≥ g√°zok: oxig√©n, nitrog√©n; v√°ltoz√≥ g√°zok: sz√©n-dioxid..."
      - ‚ö†Ô∏è FONTOS: Ha felsorol√°st k√©rt, NE HI√ÅNYOLD a mondatot, √©s NE VONJ LE pontot √©rte!
   
   B) Ha a K√âRD√âS MAGYAR√ÅZATOT/KIFEJT√âST K√âR (pl. "Magyar√°zd...", "Mi√©rt...", "Hogyan..."):
      - CSAK felsorol√°s, nincs egyetlen teljes mondat sem: MAXIMUM 6 pont!
      - ‚ö†Ô∏è √âS a "hianyossagok" mez≈ëben √çRD BE: "Nincs teljes mondat, csak felsorol√°s"
      - 1 hi√°nyos vagy t√∫l r√∂vid mondat: MAXIMUM 7 pont
      - 1-2 teljes, √©rtelmes mondat: 8-9 pont k√∂z√∂tt
      - T√∂bb kifejtett mondat, r√©szletes magyar√°zat: 10 pont lehets√©ges
   
   ‚ö†Ô∏è KRITIKUS SZAB√ÅLY - KONZISZTENCIA:
   - Ha HI√ÅNYOLOD a mondatot ‚Üí K√ñTELEZ≈ê LEVONNI a pontot (max 6 pont)!
   - Ha NEM hi√°nyolod (mert felsorol√°st k√©rt) ‚Üí NE VONJ LE pontot!
   - NE L√âGY INKONZISZTENS! Ha panaszkodsz r√°, vonj le pontot! Ha nem vonsz le, ne panaszkodj!

2. TARTALMI HIB√ÅK (PRIORIT√ÅS!):
   - Ha a v√°lasz tartalmilag HIB√ÅS, t√©ves, vagy t√©vhitet tartalmaz: MAXIMUM 2-3 pont!
   - Akkor is, ha mondatokban fogalmazott!
${appState.currentQuestion.commonMistakes ? `   - Ha a di√°k a fenti tipikus hib√°k/t√©vhitek valamelyik√©t √≠rta, MAXIMUM 2-3 pontot adj!` : ''}
   
   ‚ö†Ô∏è FONTOS - RUGALMASS√ÅG √âS MINTAV√ÅLASZ:
   - A MINTAV√ÅLASZ a helyes v√°lasz alapja, DE nem az egyetlen helyes v√°lasz!
   - Ha a di√°k M√ÅS helyes v√°laszt ad (ami faktikusan igaz, csak nincs a mint√°ban) ‚Üí FOGADD EL!
   - DE: NE b√≠r√°ld fel√ºl vagy c√°fold a mintav√°laszt! A mintav√°lasz HELYES!
   - HA hib√°t tal√°lsz: Hivatkozz a mintav√°laszra mint a helyes inform√°ci√≥ra.
   
   P√âLDA:
   - Mintav√°lasz: "Hidegfront ‚Üí heves csapad√©k, z√°por"
   - Ha di√°k ezt √≠rja ‚Üí HELYES ‚úÖ
   - Ha di√°k azt √≠rja: "Hidegfront ‚Üí hideg leveg≈ë be√°raml√°sa" ‚Üí Ez is HELYES (m√°s aspektus) ‚úÖ
   - Ha di√°k azt √≠rja: "Hidegfront ‚Üí sz√°raz id≈ë" ‚Üí Ez HIB√ÅS, hivatkozz a mintav√°laszra ‚ùå
   
3. KULCSSZAVAK HI√ÅNYOSS√ÅGAI (SZIGOR√ö ELLEN≈êRZ√âS!):
   
   ‚ö†Ô∏è KRITIKUS: Minden kulcssz√≥t k√ºl√∂n ellen≈ërizz!
   
   Kulcsszavak list√°ja: ${appState.currentQuestion.keywords}
   
   MINDEN egyes kulcssz√≥ra n√©zd meg:
   - Szerepel a v√°laszban (vagy szinonim√°ja)? ‚Üí OK
   - NEM szerepel EGY√ÅLTAL√ÅN? ‚Üí -2 pont!
   - Pontatlanul van megnevezve (hasonl√≥, de nem az)? ‚Üí -1 pont
   
   FONTOS P√âLD√ÅK:
   - Ha a kulcssz√≥ "ez√ºst jodid" √©s NEM szerepel ‚Üí -2 pont
   - Ha a kulcssz√≥ "kondenz√°ci√≥s magok" √©s CSAK "magok"-at √≠r ‚Üí -1 pont
   - Ha minden kulcssz√≥ megvan vagy szinonim√°ja ‚Üí nincs levon√°s
   
   ‚ö†Ô∏è NE L√âGY T√öLZOTTAN ELN√âZ≈ê! Ha egy konkr√©t fogalom hi√°nyzik, VONJ LE!
   
   SZ√ÅM√çT√ÅSI P√âLDA ebben az esetben:
   - Alap: 10 pont (j√≥ v√°lasz)
   - Hi√°nyz√≥ kulcsszavak sz√°ma √ó (-2 pont) = ?
   - Pontatlan kulcsszavak sz√°ma √ó (-1 pont) = ?
   - √ñsszesen levonva: ?

4. "NEM TUDOM" VAGY √úRES V√ÅLASZ:
   - "Nem tudom" vagy hasonl√≥: 0 pont!
   - √úres vagy √©rtelmetlen v√°lasz: 0 pont!

5. KULCSSZ√ì SEG√çTS√âG B√úNTET√âSE (KRITIKUS!):
   - A di√°k ${appState.hintsUsed} kulcssz√≥ seg√≠ts√©get k√©rt
   - K√ñTELEZ≈ê levonni ${appState.hintsUsed * 2} pontot a v√©gs≈ë pontsz√°mb√≥l!
   - EZ NEM OPCION√ÅLIS! Ha 1 pusk√°t k√©rt ‚Üí M√çNUSZ 2 pont!
   - Ha 2 pusk√°t k√©rt ‚Üí M√çNUSZ 4 pont!
   
   ‚ö†Ô∏è FONTOS: A "pontszam" mez≈ëben m√°r a LEVONT √©rt√©ket add meg!
   Pl. ha alapb√≥l 10 pont lenne, de 1 pusk√°t k√©rt ‚Üí "pontszam": 8

√âRT√âKEL√âSI FOLYAMAT:
0. EL≈êSZ√ñR: Ellen≈ërizd, milyen t√≠pus√∫ a K√âRD√âS!
   - Felsorol√°st k√©r? (pl. "Sorold fel", "Melyek", "Milyen t√≠pusai") ‚Üí Felsorol√°s megfelel≈ë!
   - Magyar√°zatot k√©r? (pl. "Mi√©rt", "Hogyan", "Magyar√°zd") ‚Üí Mondatok kellenek!

1. V√ÅLASZ FORM√ÅJ√ÅNAK √âRT√âKEL√âSE:
   - Ha FELSOROL√ÅST K√âRT a k√©rd√©s ‚Üí felsorol√°s is 10 pont lehet (ha helyes)
     * NE √≠rj hi√°nyoss√°got a mondatok hi√°nya miatt!
   - Ha MAGYAR√ÅZATOT K√âRT ‚Üí n√©zd meg van-e legal√°bb 1 TELJES MONDAT:
     * Ha nincs mondat ‚Üí maximum 6 pont + √çRD BE a hi√°nyoss√°gok k√∂z√©!
     * Ha van 1 r√∂vid ‚Üí maximum 7 pont
     * Ha van 1-2 j√≥ mondat ‚Üí 8-10 pont k√∂z√∂tt
     * Ha r√©szletes kifejt√©s ‚Üí 10 pont lehets√©ges
   
   ‚ö†Ô∏è KONZISZTENCIA: Ha hi√°nyolod a mondatot, akkor vonj le pontot! Ha nem vonsz le, ne hi√°nyold!

2. Azt√°n ellen≈ërizd a TARTALMAT:
   - Hib√°s/t√©vhit? ‚Üí maximum 2-3 pont (fel√ºl√≠rja a fentieket!)
   - ‚ö†Ô∏è RUGALMASS√ÅG: Ha a di√°k helyes v√°laszt ad (m√©g ha m√°s, mint a minta) ‚Üí FOGADD EL!
   - ‚ö†Ô∏è DE: NE c√°fold vagy b√≠r√°ld fel√ºl a mintav√°laszt! Az HELYES!
   - ‚ö†Ô∏è HA HIB√ÅT TAL√ÅLSZ: Hivatkozz a mintav√°laszra, de ne mondd, hogy "nem mindig" igaz!
   
3. Ellen≈ërizd a KULCSSZAVAKAT (SZIGOR√öAN!):
   
   Kulcsszavak: ${appState.currentQuestion.keywords}
   
   MINDEN EGYES KULCSSZ√ìRA:
   a) Van a v√°laszban (vagy szinonim√°ja)? ‚Üí +0 pont levon√°s
   b) Pontatlanul van megnevezve? ‚Üí -1 pont
   c) EGY√ÅLTAL√ÅN NEM szerepel? ‚Üí -2 pont
   
   √ñSSZES levon√°s kulcsszavak√©rt: ?
   
   ‚ö†Ô∏è NE FELEJTSD EL: Ha t√∂bb kulcssz√≥ is hi√°nyzik, mindegyik√©rt k√ºl√∂n vonj le!

4. ‚ö†Ô∏è V√âGS≈ê ELLEN≈êRZ√âS - 10 VS 9 PONT D√ñNT√âS:
   - Ha a v√°lasz helyes, megfelel≈ë form√°ban van, kulcsszavak megvannak ‚Üí 10 PONT!
   - Csak akkor adj 9-et (vagy kevesebbet), ha KONKR√âT hib√°t tal√°lsz!
   - Ha nem tal√°lsz konkr√©t hib√°t ‚Üí NE adj 9-et, adj 10-et!

5. V√âG√úL SZ√ÅM√çTSD KI A V√âGS≈ê PONTSZ√ÅMOT:
   
   L√âP√âSR≈êL L√âP√âSRE:
   
   1. Alap pontsz√°m (forma + tartalom): __ pont (8-10 k√∂z√∂tt ha j√≥)
   
   2. Kulcsszavak levon√°sa:
      - Teljesen hi√°nyz√≥ kulcsszavak sz√°ma: __ db √ó (-2) = -__ pont
      - Pontatlan kulcsszavak sz√°ma: __ db √ó (-1) = -__ pont
      - Kulcsszavak levon√°sa √∂sszesen: -__ pont
   
   3. Puska levon√°sa:
      - ${appState.hintsUsed} puska √ó (-2) = -${appState.hintsUsed * 2} pont
   
   4. V√âGS≈ê SZ√ÅM√çT√ÅS:
      Alap __ - kulcsszavak levon√°s __ - puska ${appState.hintsUsed * 2} = V√âGS≈ê ____ pont
   
   ‚ö†Ô∏è MINIMUM 0 PONT! Ha a levon√°sok miatt negat√≠v lenne, akkor 0 pont!
   ‚ö†Ô∏è A "pontszam" mez≈ëben a V√âGS≈ê √©rt√©ket √≠rd be (0 √©s 10 k√∂z√∂tt)!
   
   P√âLDA:
   - Ha alap 8 pont, de 6 pusk√°t k√©rt (= -12 pont levon√°s):
   - 8 - 12 = -4 ‚Üí DE minimum 0, teh√°t V√âGS≈ê PONTSZ√ÅM: 0
   
   ${appState.hintsUsed > 0 ? `
   EBBEN AZ ESETBEN: A di√°k ${appState.hintsUsed} pusk√°t haszn√°lt (${appState.hintsUsed * 2} pont levon√°s),
   √©s __ kulcssz√≥ hi√°nyzik. Ha a levon√°sok √∂sszege t√∂bb mint az alap pont ‚Üí 0 pont!
   ` : ''}

HASZN√ÅLJ AKT√çV MEGFOGALMAZ√ÅST!
- NE: "lett megfogalmazva", "ker√ºlt eml√≠t√©sre"
- IGEN: "megfogalmaztad", "√≠rtad", "eml√≠tetted"

PONTOZ√ÅSI SK√ÅLA (EZ M√ÅR A V√âGS≈ê PONTSZ√ÅM):

‚ö†Ô∏è MINIMUM 0 PONT, MAXIMUM 10 PONT!

${appState.hintsUsed > 0 ? `
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIGYELEM: A di√°k ${appState.hintsUsed} pusk√°t haszn√°lt (= -${appState.hintsUsed * 2} pont)!
Ha ez + egy√©b levon√°sok miatt negat√≠v lenne a pontsz√°m ‚Üí 0 pont!
` : ''}

- 10 pont: T√∂k√©letes v√°lasz (csak ha NEM haszn√°lt pusk√°t √âS minden kulcssz√≥ megvan!)
- 8-9 pont: Nagyon j√≥, kisebb hi√°nyoss√°gokkal
- 6-7 pont: J√≥, de hi√°nyoss√°gok vannak VAGY pusk√°t haszn√°lt
- 4-5 pont: Hi√°nyos v√°lasz
- 2-3 pont: Nagyon hi√°nyos VAGY tartalmilag hib√°s
- 1 pont: Szinte semmi
- 0 pont: "Nem tudom" VAGY t√∫l sok puska/hi√°ny (negat√≠vba ment volna)

P√âLDA - Ha mindent pusk√°nak k√©r:
- 6 kulcssz√≥, mind pusk√°nak k√©rte = 6 √ó (-2) = -12 pont levon√°s
- M√©g ha j√≥ is a v√°lasz (8 pont), 8 - 12 = -4 ‚Üí V√âGS≈ê: 0 pont!

V√°laszolj az al√°bbi JSON form√°tumban (CSAK JSON-t √≠rj, semmi m√°st):
{
  "pontszam": (0 √©s 10 k√∂z√∂tt, minimum 0!),
  "visszajelzes": "Megfogalmaztad...",
  "hianyossagok": ["Hi√°nyzik a 'kulcssz√≥1' fogalom", "T√∫l sok seg√≠ts√©get k√©rt√©l"],
  "dicseret": "..."
}

‚ö†Ô∏è Ha a levon√°sok miatt negat√≠v lenne a pontsz√°m ‚Üí √≠rj 0-t!
‚ö†Ô∏è A "hianyossagok" mez≈ëben KONKR√âTAN nevezd meg, mi hi√°nyzik vagy mi√©rt von√≥dik le pont!`;

    // Ha m√°r van m≈±k√∂d≈ë modell, haszn√°ljuk azt
    if (WORKING_MODEL) {
        try {
            const result = await tryModel(WORKING_MODEL, prompt);
            appState.evaluation = result;
            appState.isLoading = false;
            render();
            return;
        } catch (error) {
            console.log(`A kor√°bban m≈±k√∂d≈ë modell (${WORKING_MODEL}) most hib√°t adott, pr√≥b√°lunk m√°sikat...`);
            WORKING_MODEL = null;
        }
    }

    // Pr√≥b√°ljuk v√©gig a modelleket
    for (const model of MODELS_TO_TRY) {
        try {
            console.log(`Pr√≥b√°lom: ${model}...`);
            const result = await tryModel(model, prompt);
            WORKING_MODEL = model;
            console.log(`‚úÖ M≈±k√∂dik: ${model}`);
            appState.evaluation = result;
            appState.isLoading = false;
            appState.errorMessage = '';
            render();
            return;
        } catch (error) {
            console.log(`‚ùå Nem m≈±k√∂dik: ${model} - ${error.message}`);
            continue;
        }
    }

    // Ha egyik sem m≈±k√∂d√∂tt
    appState.errorMessage = `Egyik modell sem m≈±k√∂d√∂tt!\n\nPr√≥b√°lt modellek: ${MODELS_TO_TRY.join(', ')}\n\nEllen≈ërizd:\n- Az API kulcs helyes?\n- Az API kulcs enged√©lyezve van a Gemini API-hoz?\n- Van internetkapcsolat?\n- El√©rted a napi limitet? (50 k√©r√©s/nap)`;
    appState.isLoading = false;
    render();
}

// Egy adott modell kipr√≥b√°l√°sa
async function tryModel(modelName, prompt) {
    const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${appState.apiKey}`,
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            })
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`${response.status}: ${errorData.error?.message || 'Ismeretlen hiba'}`);
    }

    const data = await response.json();
    let responseText = data.candidates[0].content.parts[0].text;
    
    // JSON tiszt√≠t√°sa
    responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
    
    return JSON.parse(responseText);
}

// Renderel√©s
function render() {
    const app = document.getElementById('app');
    
    if (!appState.isSetupComplete) {
        app.innerHTML = renderSetup();
    } else {
        app.innerHTML = renderQuiz();
    }
}

function renderSetup() {
    const apiValue = appState.apiKey || '';
    const hasQuestions = appState.questions.length > 0;
    
    return `
        <div class="min-h-screen p-6 flex items-center justify-center">
            <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="flex items-center gap-3 mb-6">
                    <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <h1 class="text-3xl font-bold text-gray-800">F√∂ldrajz Kv√≠z</h1>
                </div>

                ${appState.isLoading ? `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                    <p class="mt-4 text-gray-600">K√©rd√©sek bet√∂lt√©se...</p>
                </div>
                ` : ''}

                ${appState.errorMessage ? `
                <div class="mb-6 p-4 bg-red-50 border-2 border-red-300 rounded-xl">
                    <h3 class="font-bold text-red-800 mb-2">‚ùå Hiba:</h3>
                    <p class="text-sm text-red-700 whitespace-pre-wrap">${appState.errorMessage}</p>
                </div>
                ` : ''}

                ${hasQuestions ? `
                <div class="mb-6 p-4 bg-green-50 border-2 border-green-300 rounded-xl">
                    <h3 class="font-bold text-green-800 mb-2">‚úÖ K√©rd√©sek bet√∂ltve!</h3>
                    <p class="text-sm text-green-700">${appState.questions.length} k√©rd√©s k√©szen √°ll.</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            ${apiValue ? 'API kulcs elmentve ‚úÖ' : 'Add meg a Gemini API kulcsodat'}
                        </label>
                        ${apiValue ? `
                        <div class="flex gap-2">
                            <input
                                type="password"
                                value="${apiValue.substring(0, 10)}..."
                                disabled
                                class="flex-1 p-4 border-2 border-gray-300 rounded-xl bg-gray-100"
                            />
                            <button
                                onclick="clearApiKey()"
                                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-colors"
                            >
                                T√∂rl√©s
                            </button>
                        </div>
                        ` : `
                        <input
                            type="password"
                            id="apiKeyInput"
                            value=""
                            class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none"
                            placeholder="AIzaSy..."
                        />
                        <p class="text-sm text-gray-500 mt-2">
                            Szerezd be: <a href="https://aistudio.google.com/" target="_blank" class="text-indigo-600 underline">aistudio.google.com</a>
                        </p>
                        `}
                    </div>

                    <button
                        onclick="handleSetup()"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-colors"
                    >
                        Kezdj√ºk! üöÄ
                    </button>
                </div>
                ` : `
                <div class="text-center py-8">
                    <p class="text-gray-600">CSV bet√∂lt√©se...</p>
                </div>
                `}
            </div>
        </div>
    `;
}

function renderQuiz() {
    const q = appState.currentQuestion;
    if (!q) return '<div class="p-6">Bet√∂lt√©s...</div>';
    
    return `
        <div class="min-h-screen p-6">
            <div class="max-w-3xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <!-- Fejl√©c -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">F√∂ldrajz Kv√≠z</h1>
                                    <p class="text-sm text-gray-500">
                                        ${appState.askedQuestionIds.length}/${appState.filteredQuestions.length} k√©rd√©s
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress bar -->
                        ${appState.filteredQuestions.length > 0 ? `
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full transition-all duration-500" 
                                 style="width: ${Math.round(appState.askedQuestionIds.length / appState.filteredQuestions.length * 100)}%">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 text-right mt-1">
                            ${Math.round(appState.askedQuestionIds.length / appState.filteredQuestions.length * 100)}% k√©sz
                        </p>
                        ` : ''}
                    </div>

                    <!-- Sz≈±r≈ëk -->
                    ${appState.topics.length > 1 || appState.difficulties.length > 1 ? `
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 flex gap-4 items-center">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        
                        ${appState.topics.length > 1 ? `
                        <div class="flex-1">
                            <label class="text-xs text-gray-600 block mb-1">T√©mak√∂r</label>
                            <select 
                                onchange="changeFilter('topic', this.value);"
                                class="w-full p-2 border border-gray-300 rounded-lg text-sm"
                            >
                                <option value="mind">Minden t√©mak√∂r</option>
                                ${appState.topics.map(t => `<option value="${t}" ${t === appState.selectedTopic ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                        </div>
                        ` : ''}

                        ${appState.difficulties.length > 1 ? `
                        <div class="flex-1">
                            <label class="text-xs text-gray-600 block mb-1">Neh√©zs√©g</label>
                            <select 
                                onchange="changeFilter('difficulty', this.value);"
                                class="w-full p-2 border border-gray-300 rounded-lg text-sm"
                            >
                                <option value="mind">Minden szint</option>
                                ${appState.difficulties.map(d => `<option value="${d}" ${d === appState.selectedDifficulty ? 'selected' : ''}>${d}</option>`).join('')}
                            </select>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    <!-- K√©rd√©s -->
                    <div class="bg-indigo-50 rounded-xl p-6 mb-6">
                        <div class="flex justify-between items-start mb-3">
                            <h2 class="text-xl font-semibold text-indigo-900">K√©rd√©s:</h2>
                            <div class="flex gap-2">
                                <span class="text-xs bg-indigo-200 text-indigo-800 px-3 py-1 rounded-full">${q.topic}</span>
                                <span class="text-xs bg-purple-200 text-purple-800 px-3 py-1 rounded-full">${q.difficulty}</span>
                            </div>
                        </div>
                        <p class="text-lg text-gray-700">${q.question}</p>
                        <p class="text-xs text-amber-600 mt-3 font-medium">
                            ‚ö†Ô∏è Ha a k√©rd√©s magyar√°zatot k√©r, v√°laszolj teljes mondatokban a maxim√°lis pontsz√°m√©rt!
                        </p>
                        
                        ${appState.revealedKeywords.length > 0 ? `
                        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="text-sm font-semibold text-yellow-900 mb-1">üí° Seg√≠ts√©g (-${appState.hintsUsed * 2} pont):</p>
                            <p class="text-sm text-yellow-800">${appState.revealedKeywords.join(', ')}</p>
                        </div>
                        ` : ''}
                    </div>

                    ${!appState.evaluation ? `
                    <!-- V√°lasz mez≈ë -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">A te v√°laszod:</label>
                        <textarea
                            id="userAnswerInput"
                            oninput="appState.userAnswer = this.value"
                            class="w-full h-32 p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none resize-none"
                            placeholder="√çrd ide a v√°laszodat..."
                            ${appState.isLoading ? 'disabled' : ''}
                        >${appState.userAnswer}</textarea>
                    </div>

                    <!-- Gombok -->
                    <div class="flex gap-3 mb-4">
                        <button
                            onclick="evaluateAnswer()"
                            ${appState.isLoading ? 'disabled' : ''}
                            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors disabled:bg-gray-400"
                        >
                            ${appState.isLoading ? '√ârt√©kel√©s folyamatban...' : 'V√°lasz √©rt√©kel√©se'}
                        </button>
                        <button
                            onclick="requestHint()"
                            ${appState.isLoading ? 'disabled' : ''}
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors disabled:bg-gray-400"
                            title="Kulcssz√≥ seg√≠ts√©g (-2 pont)"
                        >
                            üí° Seg√≠ts√©g
                        </button>
                        <button
                            onclick="selectRandomQuestion()"
                            ${appState.isLoading ? 'disabled' : ''}
                            class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors disabled:bg-gray-400"
                        >
                            M√°sik k√©rd√©s
                        </button>
                    </div>

                    ${appState.errorMessage ? `
                    <div class="p-4 bg-red-50 border-2 border-red-300 rounded-xl">
                        <h3 class="font-bold text-red-800 mb-2">‚ùå Hiba t√∂rt√©nt:</h3>
                        <pre class="text-sm text-red-700 whitespace-pre-wrap">${appState.errorMessage}</pre>
                    </div>
                    ` : ''}
                    ` : `
                    <!-- Eredm√©ny -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <p class="text-sm font-medium text-gray-600 mb-2">A te v√°laszod volt:</p>
                            <p class="text-gray-700 italic">"${appState.userAnswer}"</p>
                        </div>

                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white text-center">
                            <p class="text-lg mb-2">Pontsz√°m</p>
                            <p class="text-6xl font-bold">${appState.evaluation.pontszam}/10</p>
                            ${appState.hintsUsed > 0 ? `
                            <p class="text-sm mt-2 opacity-90">
                                (${appState.hintsUsed} kulcssz√≥ seg√≠ts√©g haszn√°lva: -${appState.hintsUsed * 2} pont)
                            </p>
                            ` : ''}
                        </div>

                        <div class="bg-blue-50 rounded-xl p-6">
                            <h3 class="font-semibold text-lg text-blue-900 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                √ârt√©kel√©s
                            </h3>
                            <p class="text-gray-700 leading-relaxed">${appState.evaluation.visszajelzes}</p>
                        </div>

                        ${appState.evaluation.hianyossagok && appState.evaluation.hianyossagok.length > 0 && appState.evaluation.hianyossagok[0] !== "" ? `
                        <div class="bg-amber-50 rounded-xl p-6">
                            <h3 class="font-semibold text-lg text-amber-900 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Mit lehetne jav√≠tani
                            </h3>
                            <ul class="space-y-2">
                                ${appState.evaluation.hianyossagok.map(h => `
                                <li class="text-gray-700 flex gap-2">
                                    <span class="text-amber-600">‚Ä¢</span>
                                    <span>${h}</span>
                                </li>
                                `).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${appState.evaluation.dicseret ? `
                        <div class="bg-green-50 rounded-xl p-6">
                            <h3 class="font-semibold text-lg text-green-900 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                J√≥l csin√°ltad
                            </h3>
                            <p class="text-gray-700">${appState.evaluation.dicseret}</p>
                        </div>
                        ` : ''}

                        <button
                            onclick="selectRandomQuestion()"
                            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-3 px-6 rounded-xl transition-all flex items-center justify-center gap-2"
                        >
                            K√∂vetkez≈ë k√©rd√©s
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                    `}
                </div>

                <div class="mt-6 text-center text-sm text-gray-600">
                    <p>üåç F√∂ldrajz kv√≠z gyakorl√°s Gemini AI-val</p>
                    <p>A v√°laszok nem ker√ºlnek ment√©sre - gyakorolj szabadon!</p>
                </div>
            </div>
        </div>
    `;
}

// Ind√≠t√°s - automatikus CSV bet√∂lt√©s
window.addEventListener('DOMContentLoaded', () => {
    render();
    loadQuestionsFromCSV();
});
</script>

</body>

</html>
